<head>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/mustache.js/0.8.1/mustache.js'></script>
  <script scr='javascripts/getFamilies.js'></script>
</head>

<body>
  <div class="familyname-container"></div>
    <button class="Llink">
      <a href="/rewards">To Rewards</a>
    </button>
  <div class="clear"></div>
  <div class="members-medals-container"></div>
</body>


<script id="familyname-template" type="text/x-handlebars-template">
  <h1>The {{familyName}} Family</h1>
</script>

<script id="child-points" type="text/x-handlebars-template">
  <option value="{{id}}">{{name}}</option>
</script>

<script id="memberMedal-template" type="text/x-handlebars-template">
  <h2 class="memberMain">{{role}}      {{name}}      
    <span class="points">{{task_points}}</span>
  </h2>
    {{#badges}}
  <h3 class="memberBadge"> * {{name}} *</h3>
    {{/badges}}
    {{#pendingRewards}}
  <div style="text-align:center">
  
  <form class='giveanewreward'>
    <input type='hidden' name='reward_id' value='{{id}}'>
    <input type='image' style='height: 25px' src='/assets/greencheck.png'>
  </form>
  <div class="pendingReward">  - {{name}} -  </div>
  <form class='denyanewreward'>
    <input type='hidden' name='reward_id' value='{{id}}'>
    <input type='image' style='height: 25px' src='/assets/redx.png'>
  </form>

  </div> 
  {{/pendingRewards}}
</script>


<% if parent_mode? %>
  <a href="#points-box" id='addpointsbtn' class="points-window">Add Points</a>
    <div id="points-box" class="points-popup">
    <a href="#" class="close"><img src="/assets/close_pop.png" class="btn_close" title="Close Window" alt="Close" /></a>
    <form method="post" class="addpoints" action="members/add_points">
      <%= token_tag(nil) %>
      <fieldset class="textbox">
        <label class="username">
        <span>Points to Add</span>
        <input id="addpoints" name="points" type="number" autocomplete="on" placeholder="+ points">
        </label>
        <label class="assign">
          <span>Give to:</span>
          <select class="child-points" name="name">
            <option> </option>
            </select>
            <br><br>
        </label>
        <input type='submit' class='submitchore' name="Assign_Chore">
      </fieldset>
  </form>
  </div>
  <a href="#rmpoints-box" id='removepointsbtn' class="rmpoints-window">Remove Points</a>
    <div id="rmpoints-box" class="rmpoints-popup">
    <a href="#" class="close"><img src="/assets/close_pop.png" class="btn_close" title="Close Window" alt="Close" /></a>
    <form method="post" class="rmpoints" action="members/remove_points">
      <%= token_tag(nil) %>
      <fieldset class="textbox">
        <label class="username">
        <span>Points to Add</span>
        <input id="rmpoints" name="points" type="number" autocomplete="on" placeholder="- points">
        </label>
        <label class="assign">
          <span>Give to:</span>
          <select class="child-points" name="name">
            <option> </option>
            </select>
            <br><br>
        </label>
        <input type='submit' class='submitchore' name="Assign_Chore">
      </fieldset>
  </form>
  </div>
<% end %>

<script>
$(document).ready(function() {
  $('a.points-window').click(function() {

    var pointsBox = $(this).attr('href');

    $(pointsBox).fadeIn(300);

    var popMargTop = ($(pointsBox).height() + 24) / 2;
    var popMargLeft = ($(pointsBox).width() + 24) / 2;

    $(pointsBox).css({
        'margin-top' : -popMargTop,
        'margin-left' : -popMargLeft
    });

    $('body').append('<div id="mask"></div>');
    $('#mask').fadeIn(300);

    return false;
  });

  $('.addpoints').on('submit', givePoints)

// When clicking on the button close or the mask layer the popup closed
$(document).on('click', 'a.close, #mask', function() {
  $('#mask, .points-popup').fadeOut(300, function(e) {
    $('#mask').remove();
  });
  return false;
});

});

$(document).ready(function() {
  $(document).on('submit', '.giveanewreward', giveReward)
  $(document).on('submit', '.denyanewreward', denyReward)
  $('a.rmpoints-window').click(function() {

    var rmpointsBox = $(this).attr('href');

    $(rmpointsBox).fadeIn(300);

    var popMargTop = ($(rmpointsBox).height() + 24) / 2;
    var popMargLeft = ($(rmpointsBox).width() + 24) / 2;

    $(rmpointsBox).css({
        'margin-top' : -popMargTop,
        'margin-left' : -popMargLeft
    });

    $('body').append('<div id="mask"></div>');
    $('#mask').fadeIn(300);

    return false;
  });

  $('.rmpoints').on('submit', removePoints)

$(document).on('click', 'a.close, #mask', function() {
  $('#mask, .rmpoints-popup').fadeOut(300, function(e) {
    $('#mask').remove();
  });
  return false;
});

});

var giveReward = function(e){
  e.preventDefault();
  $.ajax({
    url: '/members/give_reward',
    method: 'post',
    data: $(e.target).serialize()
  }).done(function(response){
    getFamilymembers()
  }).fail(function(response){
    console.log(response)
  })
};

var denyReward = function(e){
  e.preventDefault();
  $.ajax({
    url: '/members/deny_reward',
    method: 'post',
    data: $(e.target).serialize()
  }).done(function(response){
    getFamilymembers()
  }).fail(function(response){
    console.log(response)
  })
};

var givePoints = function(e){
  e.preventDefault();
  console.log(e.target)
  $('#mask, .points-popup').fadeOut(300, function(e) {
  $('#mask').remove();
  });
  $.ajax({
    url: '/members/add_points',
    method: 'post',
    data: $(e.target).serialize()
  }).done(function(response){
    console.log(response)
    getFamilymembers()
  }).fail(function(error){
    console.log(error)
  })
}

var removePoints = function(e){
  e.preventDefault();
  console.log(e.target)
  $('#mask, .rmpoints-popup').fadeOut(300, function(e) {
  $('#mask').remove();
  });
  $.ajax({
    url: '/members/remove_points',
    method: 'post',
    data: $(e.target).serialize()
  }).done(function(response){
    console.log(response)
    getFamilymembers()
  }).fail(function(error){
    console.log(error)
  })
}

var assignChore = function(e){
  e.preventDefault();
  $('#mask, .points-popup').fadeOut(300, function(e) {
    $('#mask').remove();
  });
  $.ajax({
    url: '/tasks',
    method: 'post',
    data: $(e.target).serialize()
  }).done(function(response){
    console.log(response)
    location.reload(false)
  }).fail(function(error){
    console.log(error)
  })
}
</script>